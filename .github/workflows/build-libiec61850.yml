name: Build libiec61850 Static Library for Windows (without install)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64]

    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4

    - name: Checkout libiec61850 repository
      uses: actions/checkout@v4
      with:
        repository: mz-automation/libiec61850
        ref: v1.6
        path: libiec61850-source

    - name: Cache dependencies (WinPcap + mbedTLS)
      id: cache-deps
      uses: actions/cache@v4
      with:
        path: |
          libiec61850-source/third_party/winpcap
          libiec61850-source/third_party/mbedtls/mbedtls-2.28
        key: ${{ runner.os }}-windows-x64-mbedtls-winpcap-${{ hashFiles('libiec61850-source/CMakeLists.txt') }}

    - name: Set up build environment (if no cache)
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        # Установка CMake через Chocolatey
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'

        # Скачивание WinPcap SDK
        curl -L -o WpdPack.zip https://www.winpcap.org/install/bin/WpdPack_4_1_2.zip 
        unzip WpdPack.zip -d libiec61850-source\\third_party\\winpcap

        # Скачивание mbedTLS 2.28
        curl -L -o mbedtls.zip https://github.com/ARMmbed/mbedtls/archive/refs/tags/v2.28.8.zip 
        unzip mbedtls.zip -d libiec61850-source\\third_party\\mbedtls

        # Проверка наличия папки перед переименованием
        SRC_DIR=libiec61850-source/third_party/mbedtls/mbedtls-2.28.8
        DST_DIR=libiec61850-source/third_party/mbedtls/mbedtls-2.28

        if [ -d "$SRC_DIR" ]; then
          mv "$SRC_DIR" "$DST_DIR"
          echo "Successfully renamed mbedtls folder"
        else
          echo "ERROR: Source directory $SRC_DIR not found!"
          exit 1
        fi
      shell: bash

    - name: Debug third-party dependencies
      run: |
        echo "Checking winpcap and mbedtls..."
        dir libiec61850-source\third_party\winpcap
        dir libiec61850-source\third_party\mbedtls
      shell: powershell

    - name: Configure CMake (Windows x64)
      run: |
        mkdir libiec61850-source\build
        cd libiec61850-source\build
        cmake .. -G "Visual Studio 17 2022" -A x64 ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DBUILD_EXAMPLES=OFF ^
          -DBUILD_DOCUMENTATION=OFF ^
          -DBUILD_SHARED_LIBS=OFF ^
          -DWITH_MBEDTLS=ON ^
          -DBUILD_HAL=OFF ^
          -DENABLE_LOGGING=OFF
      shell: cmd

    - name: Build library (Windows x64)
      run: |
        cd libiec61850-source\build
        cmake --build . --config Release --target iec61850
      shell: powershell

    - name: Archive artifacts (from build folder)
      run: |
        # Создаём временную папку для артефакта
        mkdir libiec61850-artifact
        mkdir libiec61850-artifact/lib
        mkdir libiec61850-artifact/include

        # Копируем собранную библиотеку
        cp libiec61850-source/build/src/Release/iec61850.lib libiec61850-artifact/lib/

        # Копируем заголовочные файлы
        cp -r libiec61850-source/include/* libiec61850-artifact/include/
      shell: bash

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: libiec61850-windows-x64
        path: libiec61850-artifact/
        retention-days: 7