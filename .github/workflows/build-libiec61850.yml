name: Build libiec61850 Static Library for Windows (with caching)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Checkout libiec61850
      uses: actions/checkout@v4
      with:
        repository: mz-automation/libiec61850
        ref: v1.6
        path: libiec61850-source

    - name: Cache dependencies (CMake + WinPcap + mbedTLS)
      id: cache-deps
      uses: actions/cache@v4
      with:
        path: |
          libiec61850-source/third_party/winpcap
          libiec61850-source/third_party/mbedtls
          cmake-cache
        key: ${{ runner.os }}-windows-x64-deps-${{ hashFiles('libiec61850-source/CMakeLists.txt') }}

    - name: Set up build environment (if no cache)
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        # Установка CMake через Chocolatey
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'

        # Скачивание WinPcap SDK
        curl -L -o WpdPack.zip https://www.winpcap.org/install/bin/WpdPack_4_1_2.zip 
        unzip WpdPack.zip -d libiec61850-source\third_party\winpcap

        # Скачивание mbedTLS 2.28
        curl -L -o mbedtls.zip https://github.com/ARMmbed/mbedtls/archive/refs/tags/v2.28.8.zip 
        unzip mbedtls.zip -d libiec61850-source\third_party\mbedtls
        mv libiec61850-source\third_party\mbedtls\mbedtls-2.28.8 libiec61850-source\third_party\mbedtls\mbedtls-2.28
      shell: bash

    - name: Debug third-party dependencies
      run: |
        dir libiec61850-source\third_party\winpcap
        dir libiec61850-source\third_party\mbedtls
      shell: powershell

    - name: Configure CMake (Windows x64)
      run: |
        mkdir libiec61850-source\build
        cd libiec61850-source\build
        cmake .. -G "Visual Studio 17 2022" -A x64 ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DBUILD_EXAMPLES=OFF ^
          -DBUILD_DOCUMENTATION=OFF ^
          -DBUILD_SHARED_LIBS=OFF ^
          -DWITH_MBEDTLS=ON ^
          -DCMAKE_INSTALL_PREFIX=../install
      shell: cmd

    - name: Build library (Windows x64)
      run: |
        cd libiec61850-source\build
        cmake --build . --config Release --target iec61850
      shell: powershell

    - name: Install library
      run: |
        cd libiec61850-source\build
        cmake --install . --config Release
      shell: powershell

    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libiec61850-windows-x64
        path: |
          libiec61850-source/install/lib/*
          libiec61850-source/install/include/*
        retention-days: 7